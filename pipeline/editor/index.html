<!doctype html>
<html>
	<head>
		<title>Pipeline</title>
		<style type="text/css">
			#editor {
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
                right: 0;
			}
		</style>
	</head>
	<body>
		<div id="editor"></div>

		<script src="static/ace/ace.js" type="text/javascript"></script>
		<script type="text/javascript">
			// comms
			function init_socket() {
				// socket = new WebSocket('wss://4307c6b8.ngrok.com');
				// socket = new WebSocket('ws://localhost:8765');
				socket = new WebSocket('ws://129.161.36.229:8765');

				setInterval(function() {
					socket.send(JSON.stringify({'method': 'ping'})); // ping server every 30 seconds to keep connection alive
				}, 30000);

				socket.onopen = function(event) {
					if (location.hash) {
						editor.setReadOnly(true);
						document_id = window.location.hash.substring(1);
						var data = {'method': 'join_document', 'document_id': document_id};
					} else {
						var data = {'method': 'create_document'};
						editor.focus();
					}
					socket.send(JSON.stringify(data));
				}

				socket.onclose = function(event) {
					console.log('closed, initing in a second...');
					setTimeout(init_socket, 1000);
				}

				socket.onerror = function(event) {
					console.log('socket error:');
					console.log(event);
				}

				socket.onmessage = function(event) {
					var message = JSON.parse(event.data);
					if (message.method == 'new') {
						id = message.id;
					} else if (message.method == 'edit_delta') {
						if (message.editor_id != id) {
							editor.session.getDocument().applyDeltas([message.delta]);
						}
					} else if (message.method == 'sync') {
						var cursor_pos = editor.getCursorPosition();
						var selection = editor.getSelectionRange();
						editor.setValue(message.value);
						editor.selection.setSelectionRange(selection, false);
					} else if (message.method == 'create_document') {
						document_id = message.document_id;
						history.replaceState(null, null, '#' + document_id);
					} else if (message.method == 'join_document') {
						if (message.document_value != null) {
							editor.session.setValue(message.document_value);
						}
						editor.session.getDocument().applyDeltas(message.document_deltas);
						editor.setReadOnly(false);
					}
				}
			}
			init_socket();

			// editor
			var editor = ace.edit('editor');
			editor.setTheme('ace/theme/monokai');
			editor.getSession().setMode('ace/mode/text');
			editor.$blockScrolling = Infinity
            editor.setShowPrintMargin(false);
            editor.renderer.setShowGutter(false);
            editor.setFontSize(16);

			var syncTimer;

			editor.getSession().on('change', function(e) {
				clearTimeout(syncTimer);
				if (editor.curOp && editor.curOp.command.name) {
					// console.log(e);
					var data = {'method': 'edit_delta', 'delta': e, 'document_id': document_id}
					socket.send(JSON.stringify(data));
					syncTimer = setTimeout(function() {
						var data = {'method': 'sync', 'value': editor.getValue(), 'document_id': document_id};
						socket.send(JSON.stringify(data));
					}, 2000);
				}
			});
		</script>
	</body>
</html>
